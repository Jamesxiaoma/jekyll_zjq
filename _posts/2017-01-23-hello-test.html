<!DOCTYPE html>
<html lang="ch">

<head>
    <title>test2</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/style.css" rel="stylesheet">
    <script src="jquery-3.1.1.min.js" type="text/javascript" charset="utf-8"></script>
  <style>
  ul {
    width: 128px;
}
.svg-canvas {
    height: 768px;
    /*width: 768px;*/
    border: 1px solid #000;
}

svg {
    display: block;
}

#dropCanvas * {
    overflow: auto;
}

ul li {
    list-style-type: none;
}

.wrapper {
    height: 100%;
}

.description {
    float: left;
}

.description.page-create-ttpl-drags {
    width: 200px;
    background: #dfe3e9;
}

.page-create-select-wrapper {
    padding: 5px;
    height: 100%;
}

.description.page-create-ttpl-config {
    position: absolute;
    top: 0;
    right: 0;
    width: 250px;
    background: #fff;
    overflow-x: hidden;
    overflow-y: auto;
}

.topology-template-preview {
    margin-left: 215px;
    margin-right: 265px;
    background: #fff;
}

.ttpl-preview-editor {
    position: relative;
}

ul.drags-svg li {
    width: 110px;
    display: inline-block;
}

.ttpl-create-toolbar,
.page-detail-ttpl .topology-template-preview .ttpl-preview-wrapper .ttpl-preview .ttpl-preview-canvas .ttpl-create-toolbar,
.select-recommend-preview .topology-template-preview .ttpl-preview-wrapper .ttpl-preview .ttpl-preview-canvas .ttpl-create-toolbar {
    position: absolute;
    z-index: 20;
    top: 10px;
    padding: 10px 20px 0;
    line-height: normal;
    text-align: left;
}

.topology-template-preview .common-graph {
    min-height: 400px;
    position: relative;
}

li.network-li {
    display: inline-block;
    width: 70px;
}

div.networkIcon {
    display: inline-block;
}

li#network.network-color-0 svg path {
    fill: #10ae92;
}

li#network.network-color-1 svg path {
    fill: #3c7afe;
}

li#network.network-color-2 svg path {
    fill: #eb6b4e;
}

li#network.network-color-3 svg path {
    fill: #f9ca5e;
}

li#network.network-color-4 svg path {
    fill: #900781;
}
  </style>
</head>

<body>
    <div class="ttpl-preview-editor">
        <div class="description page-create-ttpl-drags" style="height: 760px;">
            <div class="page-create-select-wrapper">
                <h2>设备</h2>
                <ul>
                    <li draggable="true" id="instance">
                        <svg id="instanceIcon" version="1.1" baseProfile="full" width="156" height="48" xmlns="http://www.w3.org/2000/svg" fill="#000">
                            <path d="M42 4H6C3.79 4 2 5.79 2 8v24c0 2.21 1.79 4 4 4h14v4h-4v4h16v-4h-4v-4h14c2.21 0 4-1.79 4-4V8c0-2.21-1.79-4-4-4zm0 28H6V8h36v24z" />
                            <text x=56 y=28>主机</text>
                        </svg>
                    </li>
                    <li draggable="true" id="volume">
                        <svg id="volumeIcon" version="1.1" baseProfile="full" width="156" height="48" xmlns="http://www.w3.org/2000/svg" fill="#000">
                            <path d="M42 6H6c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h36c2.21 0 4-1.79 4-4V10c0-2.21-1.79-4-4-4zm0 32H6V10h20v8h16v20z" />
                            <text x=56 y=28>硬盘</text>
                        </svg>
                    </li>
                    <li draggable="true" id="test1">
                        <svg id="test1Icon" version="1.1" baseProfile="full" width="156" height="48" xmlns="http://www.w3.org/2000/svg" fill="#000">
                            <path d="M24 32.5l8-8h-6v-18h-4v18h-6l8 8zm18-26H30v3.97h12v28.06H6V10.47h12V6.5H6c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h36c2.21 0 4-1.79 4-4v-28c0-2.21-1.79-4-4-4z" />
                            <text x=56 y=28>test1</text>
                        </svg>
                    </li>
                    </li>
                </ul>
                <hr/>
                <h2>网络</h2>
                <ul>
                    <li draggable="true" id="network-1">
                        <svg id="net-1Icon" version="1.1" baseProfile="full" width="156" height="48" xmlns="http://www.w3.org/2000/svg" fill="#000">
                            <path d="M13.98 22L6 30l7.98 8v-6H28v-4H13.98v-6zM42 18l-7.98-8v6H20v4h14.02v6L42 18z" />
                            <text x=56 y=28>网络1</text>
                        </svg>
                    </li>
                    <li draggable="true" id="network-2">
                        <svg id="net-1Icon" version="1.1" baseProfile="full" width="156" height="48" xmlns="http://www.w3.org/2000/svg" fill="#000">
                            <path d="M13.98 22L6 30l7.98 8v-6H28v-4H13.98v-6zM42 18l-7.98-8v6H20v4h14.02v6L42 18z" />
                            <text x=56 y=28>网络2</text>
                        </svg>
                    </li>
                    <li draggable="true" id="network-3">
                        <svg id="net-1Icon" version="1.1" baseProfile="full" width="156" height="48" xmlns="http://www.w3.org/2000/svg" fill="#000">
                            <path d="M13.98 22L6 30l7.98 8v-6H28v-4H13.98v-6zM42 18l-7.98-8v6H20v4h14.02v6L42 18z" />
                            <text x=56 y=28>网络3</text>
                        </svg>
                    </li>
                </ul>
            </div>
        </div>
        <div class="description page-create-ttpl-config" style="height: 760px;">
            <div class="wrapper">
                <h3>资源配置</h3>
                <hr/>
                <div class="text-ttlp-config" ng-show="vm.devices.length">
                    <p>名称:test</p>
                    <p>描述:无</p>
                    <p>内存 1G</p>
                    <p>用户名 root</p>
                </div>
                <p>test</p>
                <h3>网络配置</h3>
                <hr/>
                <br>
                <!--<div ng-repeat="network in vm.networks" class="networkIcon">
                    <li draggable="true" title="{{ network.name }}" class="network-li network-color-{{ $index%5 }}" id="network">
                        <svg id="networkIcon" version="1.1" baseProfile="full" width="40" height="32" xmlns="http://www.w3.org/2000/svg" fill="#000">
                            <path d="M4,24c0,11.05,8.95,20,20,20s20-8.95,20-20S35.05,4,24,4S4,12.95,4,24z M18,35l-7-7l7-7v5h8v4h-8V35z M30,13l7,7l-7,7v-5h-8 v-4h8V13z" />
                            <text x=2 y=10>{{ network.name }}</text>
                        </svg>
                    </li>
                </div>-->
            </div>
        </div>
        <div class="topology-template-preview">
            <div class="svg-canvas" id="dropEle" draggable="false">
                <svg id="dropCanvas" version="1.1" baseProfile="full" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" draggable="false">
                    <defs>
                        <pattern id="pattern" x="0" y="0" width="9" height="9" patternUnits="userSpaceOnUse">
                            <path d="m 9 0 l 0 9 l -9 0" stroke="#ddd" stroke-width="1px" fill="none">
                        </pattern>
                    </defs>
                    <rect x=0 y=0 width="100%" height="100%" fill="url(#pattern)" />
                    <svg id="dropCanvasAll" x=0 y=0 version="1.1" xmlns="http://www.w3.org/2000/svg">
                        <svg id="dropCanvasRight" width="1920" x=0 y=0 version="1.1" xmlns="http://www.w3.org/2000/svg">
                        </svg>
                        <svg id="dropCanvasLeft" width="1920" x=0 y=0 version="1.1" xmlns="http://www.w3.org/2000/svg">
                        </svg>
                    </svg>
                </svg>
            </div>
        </div>
    </div>
    <script >
    //构造函数，构造Device类，即所有设备的构造函数
function Device(type, dropSwitch, foresideType, id, name, objHeight) {
    this.type = type; //设备类型
    this.dropSwitch = dropSwitch; //设备是否可放置状态的开关
    this.foresideType = foresideType || [""]; //设备可以放在哪些设备后
    this.id = id; //设备ID，不可变，唯一
    this.name = name; //设备名，可变
    this.foresideObjId = ""; //当前设备的上层设备的ID
    
    this.objHeight = objHeight || 1; //设备占高
    this.childDevices = []; //子设备
    this.objRelativelyHeight = 0; //设备相对高度
    this.objColumn = 0;
    this.leanRight = true;
}

var provisionalDeviceObj; //临时设备对象，用作事件间的信息传递


var devicesRight = { //设备象数组右
    "id": "devicesRight",
    "objHeight": 0,
    "childDevices": [],
    "objRelativelyHeight": 0,
    "objColumn": 0
};

var devicesLeft = { //设备象数组左
    "id": "devicesLeft",
    "objHeight": 0,
    "childDevices": [],
    "objRelativelyHeight": 0,
    "objColumn": 0
};

var devices = { //设备象数组
    "id": "devices",
    "objHeight": 0,
    "childDevices": [devicesRight, devicesLeft],
    "objRelativelyHeight": 0,
    "objColumn": 0
};


var instanceCount = 0;
var volumeCount = 0;
var test1Count = 0;


document.ondragstart = function (event) { //监听整个DOM上的拖拽开始事件dragstart
    var type = event.target.id; //获取事件发生元素的ID，ID是设备类型，即type
    provisionalDeviceObj = creatDevice(type); //创建当前type类型的对象，并由provisionalDeviceObj保存
    event.dataTransfer.setData("Text", provisionalDeviceObj.id); //事件传递信息设为provisionalDeviceObj.id
}

$("#dropEle")[0].ondragover = function (event) { //设置画布"#dropEle"允许放置，阻止对元素的默认处理方式
    event.preventDefault();
}

$("#dropEle")[0].ondrop = function (event) { //监听画布"#dropEle"的ondrop放置事件，阻止对元素的默认处理方式（打开链接）
    event.preventDefault();
    if (provisionalDeviceObj.dropSwitch === true) { //如果临时对象的dropSwitch属性为真
        switch (provisionalDeviceObj.type) {
            case "instance":
                instanceCount++;
                provisionalDeviceObj.id = "instances" + instanceCount;
                provisionalDeviceObj.name = "新建主机" + instanceCount;
                break;
            case "volume":
                volumeCount++;
                provisionalDeviceObj.id = "volume" + volumeCount;
                provisionalDeviceObj.name = "新建硬盘" + volumeCount;
                break;
            case "test1":
                test1Count++;
                provisionalDeviceObj.id = "test1" + test1Count;
                provisionalDeviceObj.name = "test1" + test1Count;
                break;
        }


        if ($(event.target).parent()[0].id === "dropCanvas") {
            if (provisionalDeviceObj.leanRight) {
                provisionalDeviceObj.foresideObjId = "devicesRight"; //设置其设备的上层设备的ID
            } else {
                provisionalDeviceObj.foresideObjId = "devicesLeft"; //设置其设备的上层设备的ID
            }
        } else {
            provisionalDeviceObj.foresideObjId = $(event.target).parent()[0].id; //设置其设备的上层设备的ID
        }


        //********对网络对象的特殊处理********//
        var testNetType = /^network-/;
        if (testNetType.test(provisionalDeviceObj.id)) {
            provisionalDeviceObj.foresideObjId = "devicesLeft";
            provisionalDeviceObj.inDomain[0] = $(event.target).parent()[0].id;
        }
        //********对网络对象的特殊处理********//


        if ($($(event.target).parent()[0]).attr("objColumn")) {
            provisionalDeviceObj.objColumn = parseInt($($(event.target).parent()[0]).attr("objColumn")) + 1;
        } else {
            provisionalDeviceObj.objColumn = 1;
        }

        if (provisionalDeviceObj.type === "net-1") {
            provisionalDeviceObj.objColumn = 1;
        }

        pushObject(devices, provisionalDeviceObj);

        setObjHeight(devices);

        $("#dropCanvasRight svg,#dropCanvasLeft svg,.objLine").remove();
        draw(devices);
        linkObj(devices);
        setDropDeviceObject(); //对画布上的所有元素绑定事件

    } else { //如果临时对象的dropSwitch属性为假，则弹出警告
        alert("请将设备放置在正确位置.");
    }
    console.log(devices);
    console.log("*******************************************************")
}


function pushObject(rootObj, obj) {
    for (var i = 0; i < rootObj.childDevices.length; i++) {
        if (rootObj.childDevices[i].id === obj.id) {
            obj.foresideObjId = null;
            //********对网络对象的特殊处理********//
            if (obj.inDomain) {
                if (rootObj.childDevices[i].inDomain.indexOf(obj.inDomain[0]) === -1) {
                    rootObj.childDevices[i].inDomain.push(obj.inDomain[0]);
                }
            }
            //********对网络对象的特殊处理********//
        } else {
            pushObject(rootObj.childDevices[i], obj);
            if (rootObj.childDevices[i].id === obj.foresideObjId) {
                rootObj.childDevices[i].childDevices.push(obj);
            }
            if (rootObj.childDevices[i].childDevices.length) {
                rootObj.childDevices[i].objHeight = 0;
            }
        }
    }
}

function creatDevice(type) { //创建特定type类型的对象
    var typeObj;
    switch (type) {
        case "instance":
            typeObj = new Device("instance", true);
            break;
        case "volume":
            typeObj = new Device("volume", false, ["instance"]);
            break;
        case "test1":
            typeObj = new Device("test1", false, ["volume", "instance",'network']);
            break;
        // case "net-1":
        //     typeObj = new Device("net-1", false, ["instance"], "net-1", "网络1");
        //     typeObj.leanRight = false;
        //     typeObj.inDomain = [];
        //     break;
    }

    if (type.indexOf('network-') === 0) {
        // type, dropSwitch, foresideType, id, name, objHeight
        typeObj = new Device("network", false, ["instance"], type);
        typeObj.leanRight = false;
        typeObj.inDomain = [];
    }


    return typeObj;
};


function setDropDeviceObject() { //将所有画布上的元素绑定事件
    $("#dropCanvas svg").on("dragover", function (event) {
        event.preventDefault();
        if ($.inArray($(event.target).parent().attr('class'), provisionalDeviceObj.foresideType) != -1) {
            $(event.target).parent().attr('fill', '#1d83f6');
            provisionalDeviceObj.dropSwitch = true;
        }
    });
    $("#dropCanvas svg").on("dragleave", function (event) {
        event.preventDefault();
        $(event.target).parent().attr('fill', '#000');
        provisionalDeviceObj.dropSwitch = false;
    });
}

function draw(obj) {

    drawRight(obj.childDevices[0]);
    drawLeft(obj.childDevices[1]);

    function drawRight(rightObj) {
        console.log(rightObj.id + " : " + rightObj.objHeight);
        for (var i = 0; i < rightObj.childDevices.length; i++) {

            rightObj.childDevices[i].objRelativelyHeight = ((rightObj.childDevices.length > 1) ? 
                ((i > 0) ? rightObj.childDevices[i].objRelativelyHeight * 0.5 + rightObj.childDevices[i - 1].objRelativelyHeight + rightObj.childDevices[i - 1].objHeight * 0.5 :
                 rightObj.objRelativelyHeight + rightObj.childDevices[i].objRelativelyHeight * 0.5 - rightObj.objHeight * 0.5) 
                : rightObj.objRelativelyHeight);

            var dropDeviceObject = $("#" + rightObj.childDevices[i].type + " svg").clone();
            dropDeviceObject.attr({
                id: rightObj.childDevices[i].id,
                class: rightObj.childDevices[i].type,
                objColumn: rightObj.childDevices[i].objColumn,
                x: 256 * rightObj.childDevices[i].objColumn,
                y: 48 * (rightObj.childDevices[i].objRelativelyHeight) + 384
            });
            $("#dropCanvasRight").append(dropDeviceObject);
            $("#" + rightObj.childDevices[i].id + " text").html(rightObj.childDevices[i].name);

            drawRight(rightObj.childDevices[i]);
        }
    }

    function drawLeft(leftObj) {
        console.log(leftObj.id + " : " + leftObj.objHeight);
        for (var i = 0; i < leftObj.childDevices.length; i++) {

            leftObj.childDevices[i].objRelativelyHeight = ((leftObj.childDevices.length > 1) ? ((i > 0) ? leftObj.childDevices[i].objRelativelyHeight * 0.5 + leftObj.childDevices[i - 1].objRelativelyHeight + leftObj.childDevices[i - 1].objHeight * 0.5 : leftObj.objRelativelyHeight + leftObj.childDevices[i].objRelativelyHeight * 0.5 - leftObj.objHeight * 0.5) : leftObj.objRelativelyHeight);

            var dropDeviceObject = $("#" + leftObj.childDevices[i].type + " svg").clone();
            dropDeviceObject.attr({
                id: leftObj.childDevices[i].id,
                class: leftObj.childDevices[i].type,
                objColumn: leftObj.childDevices[i].objColumn,
                x: -256 * leftObj.childDevices[i].objColumn + 128,
                y: 48 * (leftObj.childDevices[i].objRelativelyHeight) + 384
            });
            $("#dropCanvasLeft").append(dropDeviceObject);
            $("#" + leftObj.childDevices[i].id + " text").html(leftObj.childDevices[i].name);
            drawLeft(leftObj.childDevices[i]);
        }
    }
}


function setObjHeight(obj) {

    setRightObjHeight(obj.childDevices[0]);
    setLeftObjHeight(obj.childDevices[1]);

    function setRightObjHeight(rightobj) {
        for (var i = 0; i < rightobj.childDevices.length; i++) {
            setRightObjHeight(rightobj.childDevices[i]);
            rightobj.objHeight = rightobj.objHeight + rightobj.childDevices[i].objHeight;
            rightobj.childDevices[i].objRelativelyHeight = rightobj.childDevices[i].objHeight;
        }
    }

    function setLeftObjHeight(leftobj) {
        for (var i = 0; i < leftobj.childDevices.length; i++) {
            setLeftObjHeight(leftobj.childDevices[i]);
            leftobj.objHeight = leftobj.objHeight + leftobj.childDevices[i].objHeight;
            leftobj.childDevices[i].objRelativelyHeight = leftobj.childDevices[i].objHeight;
        }
    }
}

function linkObj(obj) {
    linkRightObj(obj.childDevices[0]);
    linkLeftObj(obj.childDevices[1]);

    function linkRightObj(rightobj) {
        for (var i = 0; i < rightobj.childDevices.length; i++) {
            linkRightObj(rightobj.childDevices[i]);
            var x1 = 256 * rightobj.childDevices[i].objColumn - 128;
            var y1 = 48 * (rightobj.childDevices[i].objRelativelyHeight) + 384;

            var y2 = 48 + ((rightobj.childDevices[i].objHeight > 1) ? (rightobj.childDevices[i].objHeight - 1) * 24 : 0);
            var y3 = -24 - ((rightobj.childDevices[i].objHeight > 1) ? (rightobj.childDevices[i].objHeight - 1) * 24 : 0);


            document.getElementById("dropCanvasAll").insertAdjacentHTML("beforeend", "<path class='objLine' d =' M " + x1 + " " + y1 + "  v " + y2 + " m 0 " + y3 + " h 128' stroke = 'black' fill='transparent'/>");
        }
    }

    function linkLeftObj(leftobj) {
        for (var i = 0; i < leftobj.childDevices.length; i++) {
            linkLeftObj(leftobj.childDevices[i]);
            var x1 = -256 * leftobj.childDevices[i].objColumn + 256 + 128;
            var y1 = 48 * (leftobj.childDevices[i].objRelativelyHeight) + 384;

            var y2 = 48 + ((leftobj.childDevices[i].objHeight > 1) ? (leftobj.childDevices[i].objHeight - 1) * 24 : 0);
            var y3 = -24 - ((leftobj.childDevices[i].objHeight > 1) ? (leftobj.childDevices[i].objHeight - 1) * 24 : 0);

            document.getElementById("dropCanvasAll").insertAdjacentHTML("beforeend", "<path class='objLine' d =' M " + x1 + " " + y1 + "  v " + y2 + " m 0 " + y3 + " h -128' stroke = 'black' fill='transparent'/>");
        }
    }

}


dragable();

function dragable() {
    var x, y;
    var $dragSVG = $("#dropCanvasAll");
    $('#dropCanvas').on("mousedown", function (event) {
        x = event.clientX - $dragSVG.attr("x");
        y = event.clientY - $dragSVG.attr("y");
        $(document).on("mousemove", function (event) {
            $dragSVG.attr("x", event.clientX - x);
            $dragSVG.attr("y", event.clientY - y);
        });
    });
    $(document).on("mouseup", function (event) {
        $(document).off("mousemove");
    });
}
    
    
    </script>
</body>

</html>

